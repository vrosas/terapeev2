import {
  AlertCircle, ArrowRight, ArrowUpRight, Calendar, Check, CheckCircle2, Clock,
  CreditCard, DollarSign, MessageSquare, MoreHorizontal, RefreshCw, Timer,
  TrendingUp, Users, Video, XCircle
} from 'lucide-react'
import {
  Area,
  AreaChart,
  Bar,
  BarChart,
  CartesianGrid,
  Line,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis
} from 'recharts'
import { T } from '@/utils/theme'
import { Badge, StatCard } from '@/components/ui'
import { useAppStore } from '@/lib/store'

/* â”€â”€â”€ Mock Data â”€â”€â”€ */
const MOCK_APPOINTMENTS_TODAY = [
  { id: 1, time: "08:00", patient: "Maria Silva", service: "Psicoterapia", professional: "Dra. Ana Costa", type: "presencial", status: "confirmado", duration: 50 },
  { id: 2, time: "09:00", patient: "JoÃ£o Pereira", service: "Fisioterapia", professional: "Dr. Carlos Lima", type: "online", status: "pendente", duration: 45 },
  { id: 3, time: "09:30", patient: "Lucia Fernandes", service: "Fonoaudiologia", professional: "Dra. Beatriz Rocha", type: "presencial", status: "confirmado", duration: 30 },
  { id: 4, time: "10:00", patient: "Pedro Santos", service: "Psicoterapia", professional: "Dra. Ana Costa", type: "presencial", status: "sem_resposta", duration: 50 },
  { id: 5, time: "11:00", patient: "Ana Oliveira", service: "Terapia Ocupacional", professional: "Dr. Ricardo Alves", type: "presencial", status: "confirmado", duration: 45 },
  { id: 6, time: "14:00", patient: "Roberto Gomes", service: "Psicoterapia", professional: "Dra. Ana Costa", type: "online", status: "pendente", duration: 50 },
  { id: 7, time: "15:00", patient: "Fernanda Dias", service: "Fisioterapia", professional: "Dr. Carlos Lima", type: "presencial", status: "cancelado", duration: 45 },
  { id: 8, time: "16:00", patient: "Marcos Ribeiro", service: "Fonoaudiologia", professional: "Dra. Beatriz Rocha", type: "presencial", status: "reagendar", duration: 30 },
]
const MOCK_REVENUE_CHART = [
  { month: "Jul", receita: 18200, meta: 20000 },{ month: "Ago", receita: 22500, meta: 20000 },
  { month: "Set", receita: 19800, meta: 22000 },{ month: "Out", receita: 25100, meta: 22000 },
  { month: "Nov", receita: 23400, meta: 24000 },{ month: "Dez", receita: 28700, meta: 24000 },
  { month: "Jan", receita: 26200, meta: 26000 },
]
const MOCK_WEEKLY = [
  { day: "Seg", total: 18, confirmados: 14 },{ day: "Ter", total: 22, confirmados: 19 },
  { day: "Qua", total: 16, confirmados: 12 },{ day: "Qui", total: 24, confirmados: 20 },
  { day: "Sex", total: 20, confirmados: 17 },{ day: "SÃ¡b", total: 8, confirmados: 7 },
]
const MOCK_OVERDUE = [
  { patient: "Carlos Mendes", amount: 350, dueDate: "10/01/2025", service: "Psicoterapia (4 sessÃµes)" },
  { patient: "PatrÃ­cia Lopes", amount: 180, dueDate: "08/01/2025", service: "Fisioterapia" },
  { patient: "Ricardo Tavares", amount: 520, dueDate: "03/01/2025", service: "Plano mensal" },
]

const STATUS_MAP = {
  pendente: { label: "Pendente", color: T.warning, bg: "rgba(245,158,11,0.10)", icon: Clock },
  confirmado: { label: "Confirmado", color: T.success, bg: "rgba(22,163,74,0.10)", icon: CheckCircle2 },
  cancelado: { label: "Cancelado", color: T.error, bg: "rgba(220,38,38,0.10)", icon: XCircle },
  reagendar: { label: "Reagendar", color: "#F97316", bg: "rgba(249,115,22,0.10)", icon: RefreshCw },
  sem_resposta: { label: "Sem resposta", color: T.n400, bg: "rgba(201,205,216,0.15)", icon: Timer },
  realizado: { label: "Realizado", color: T.info, bg: "rgba(37,99,235,0.10)", icon: Check },
}

function StatusBadge({ status }) {
  const s = STATUS_MAP[status] || STATUS_MAP.pendente; const Icon = s.icon
  return (<span style={{ display:"inline-flex",alignItems:"center",gap:5,padding:"4px 10px",borderRadius:20,background:s.bg,color:s.color,fontSize:12,fontWeight:500,whiteSpace:"nowrap" }}><Icon size={12}/>{s.label}</span>)
}

function AppointmentRow({ apt, idx }) {
  return (
    <div style={{ display:"flex",alignItems:"center",gap:16,padding:"14px 20px",borderBottom:`1px solid ${T.n100}`,transition:"background 150ms",opacity:apt.status==="cancelado"?0.5:1,animation:`fadeSlideUp 0.35s ease ${idx*0.04}s both` }}
      onMouseEnter={e=>e.currentTarget.style.background=T.n100} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
      <div style={{ width:52,flexShrink:0,textAlign:"center" }}>
        <div style={{ fontSize:15,fontWeight:600,color:T.n900 }}>{apt.time}</div>
        <div style={{ fontSize:11,color:T.n400 }}>{apt.duration}min</div>
      </div>
      <div style={{ width:10,height:10,borderRadius:"50%",flexShrink:0,background:STATUS_MAP[apt.status]?.color||T.n400,boxShadow:`0 0 0 3px ${STATUS_MAP[apt.status]?.bg||T.n200}` }}/>
      <div style={{ flex:1,minWidth:0 }}>
        <div style={{ fontSize:14,fontWeight:500,color:T.n900,display:"flex",alignItems:"center",gap:8 }}>
          {apt.patient}
          {apt.type==="online"&&<span style={{ display:"inline-flex",alignItems:"center",gap:3,fontSize:11,color:T.info,background:"rgba(37,99,235,0.08)",padding:"2px 6px",borderRadius:4,fontWeight:500 }}><Video size={10}/> Online</span>}
        </div>
        <div style={{ fontSize:12,color:T.n400,marginTop:2 }}>{apt.service} Â· {apt.professional}</div>
      </div>
      <StatusBadge status={apt.status}/>
      <button style={{ width:32,height:32,borderRadius:6,border:"none",background:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400,transition:"all 150ms" }}
        onMouseEnter={e=>{e.currentTarget.style.background=T.n200;e.currentTarget.style.color=T.n700}} onMouseLeave={e=>{e.currentTarget.style.background="transparent";e.currentTarget.style.color=T.n400}}>
        <MoreHorizontal size={16}/>
      </button>
    </div>
  )
}

function CustomTooltip({ active, payload, label }) {
  if(!active||!payload?.length) return null
  return (
    <div style={{ background:T.n0,border:`1px solid ${T.n200}`,borderRadius:T.radiusMd,padding:"10px 14px",boxShadow:T.shadowMd,fontSize:12 }}>
      <div style={{ fontWeight:600,marginBottom:4,color:T.n900 }}>{label}</div>
      {payload.map((p,i)=>(
        <div key={i} style={{ display:"flex",alignItems:"center",gap:6,color:T.n700,marginTop:2 }}>
          <div style={{ width:8,height:8,borderRadius:2,background:p.color }}/>{p.name==="receita"?"Receita":p.name==="meta"?"Meta":p.name==="confirmados"?"Confirmados":"Total"}: <strong>{p.name==="receita"||p.name==="meta"?`R$ ${p.value.toLocaleString("pt-BR")}`:p.value}</strong>
        </div>
      ))}
    </div>
  )
}

export default function DashboardContent() {
  const navigate = useAppStore(s=>s.navigate)
  const confirmed = MOCK_APPOINTMENTS_TODAY.filter(a=>a.status==="confirmado").length
  const pending = MOCK_APPOINTMENTS_TODAY.filter(a=>a.status==="pendente"||a.status==="sem_resposta").length
  const total = MOCK_APPOINTMENTS_TODAY.length

  return (
    <div style={{ padding:"28px 32px",maxWidth:1280 }}>
      <div style={{ marginBottom:28,animation:"fadeSlideUp 0.35s ease both" }}>
        <h1 style={{ fontSize:24,fontWeight:700,color:T.n900,letterSpacing:"-0.01em" }}>Bom dia, Dr. Rafael ðŸ‘‹</h1>
        <p style={{ fontSize:14,color:T.n400,marginTop:4 }}>Aqui estÃ¡ o resumo da sua clÃ­nica para hoje</p>
      </div>

      <div style={{ display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:16,marginBottom:28 }}>
        <StatCard icon={Calendar} label="Consultas hoje" value={total} subtext={`${confirmed} confirmadas Â· ${pending} pendentes`} color={T.primary500} delay={0.05}/>
        <StatCard icon={CreditCard} label="CobranÃ§as abertas" value="R$ 4.280" subtext="12 faturas em aberto" trend="+8%" trendUp color={T.warning} delay={0.1}/>
        <StatCard icon={AlertCircle} label="CobranÃ§as atrasadas" value="R$ 1.050" subtext="3 faturas vencidas" trend="-12%" trendUp={false} color={T.error} delay={0.15}/>
        <StatCard icon={CheckCircle2} label="Taxa de confirmaÃ§Ã£o" value="78%" subtext="Ãšltimos 30 dias" trend="+5%" trendUp color={T.success} delay={0.2}/>
      </div>

      <div style={{ display:"grid",gridTemplateColumns:"1fr 380px",gap:20 }}>
        <div style={{ display:"flex",flexDirection:"column",gap:20 }}>
          {/* Today's appointments */}
          <div style={{ background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowSoft,border:`1px solid ${T.n200}`,overflow:"hidden",animation:"fadeSlideUp 0.4s ease 0.15s both" }}>
            <div style={{ padding:"18px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",borderBottom:`1px solid ${T.n200}` }}>
              <div style={{ display:"flex",alignItems:"center",gap:10 }}>
                <h2 style={{ fontSize:16,fontWeight:600 }}>Consultas de hoje</h2>
                <span style={{ background:T.primary50,color:T.primary500,fontSize:12,fontWeight:600,padding:"3px 9px",borderRadius:10 }}>{total}</span>
              </div>
              <button onClick={()=>navigate('agenda')} style={{ display:"flex",alignItems:"center",gap:5,border:"none",background:"transparent",cursor:"pointer",fontFamily:T.font,fontSize:13,fontWeight:500,color:T.primary500,padding:"6px 10px",borderRadius:6,transition:"background 150ms" }}
                onMouseEnter={e=>e.currentTarget.style.background=T.primary50} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                Ver agenda <ArrowRight size={14}/>
              </button>
            </div>
            <div>{MOCK_APPOINTMENTS_TODAY.map((apt,i)=><AppointmentRow key={apt.id} apt={apt} idx={i}/>)}</div>
          </div>

          {/* Revenue chart */}
          <div style={{ background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowSoft,border:`1px solid ${T.n200}`,padding:"20px 24px",animation:"fadeSlideUp 0.4s ease 0.25s both" }}>
            <div style={{ display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20 }}>
              <div><h2 style={{ fontSize:16,fontWeight:600 }}>Receita mensal</h2><div style={{ fontSize:13,color:T.n400,marginTop:2 }}>Ãšltimos 7 meses</div></div>
              <div style={{ textAlign:"right" }}>
                <div style={{ fontSize:22,fontWeight:700,color:T.n900,letterSpacing:"-0.01em" }}>R$ 26.200</div>
                <div style={{ fontSize:12,color:T.success,fontWeight:500,display:"flex",alignItems:"center",gap:3,justifyContent:"flex-end" }}><TrendingUp size={12}/> +12% vs mÃªs anterior</div>
              </div>
            </div>
            <ResponsiveContainer width="100%" height={220}>
              <AreaChart data={MOCK_REVENUE_CHART} margin={{ top:5,right:5,bottom:0,left:-10 }}>
                <defs><linearGradient id="grad_receita" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={T.primary500} stopOpacity={0.15}/><stop offset="95%" stopColor={T.primary500} stopOpacity={0}/></linearGradient></defs>
                <CartesianGrid strokeDasharray="3 3" stroke={T.n200} vertical={false}/>
                <XAxis dataKey="month" axisLine={false} tickLine={false} tick={{ fontSize:12,fill:T.n400 }}/>
                <YAxis axisLine={false} tickLine={false} tick={{ fontSize:11,fill:T.n400 }} tickFormatter={v=>`${(v/1000).toFixed(0)}k`}/>
                <Tooltip content={<CustomTooltip/>}/>
                <Area type="monotone" dataKey="meta" stroke={T.n300} strokeWidth={2} strokeDasharray="6 3" fill="none" dot={false}/>
                <Area type="monotone" dataKey="receita" stroke={T.primary500} strokeWidth={2.5} fill="url(#grad_receita)" dot={{ fill:T.primary500,r:4,strokeWidth:0 }} activeDot={{ fill:T.primary500,r:6,stroke:T.n0,strokeWidth:3 }}/>
              </AreaChart>
            </ResponsiveContainer>
            <div style={{ display:"flex",gap:20,marginTop:8 }}>
              <div style={{ display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400 }}><div style={{ width:12,height:3,borderRadius:2,background:T.primary500 }}/> Receita</div>
              <div style={{ display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400 }}><div style={{ width:12,height:3,borderRadius:2,background:T.n300 }}/> Meta</div>
            </div>
          </div>
        </div>

        <div style={{ display:"flex",flexDirection:"column",gap:20 }}>
          {/* Weekly chart */}
          <div style={{ background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowSoft,border:`1px solid ${T.n200}`,padding:"20px 24px",animation:"fadeSlideUp 0.4s ease 0.2s both" }}>
            <h2 style={{ fontSize:16,fontWeight:600,marginBottom:4 }}>Agenda da semana</h2>
            <div style={{ fontSize:13,color:T.n400,marginBottom:16 }}>Agendamentos por dia</div>
            <ResponsiveContainer width="100%" height={180}>
              <BarChart data={MOCK_WEEKLY} barGap={4} margin={{ top:0,right:0,bottom:0,left:-20 }}>
                <XAxis dataKey="day" axisLine={false} tickLine={false} tick={{ fontSize:12,fill:T.n400 }}/>
                <YAxis axisLine={false} tickLine={false} tick={{ fontSize:11,fill:T.n400 }}/>
                <Tooltip content={<CustomTooltip/>}/>
                <Bar dataKey="total" fill={T.n200} radius={[4,4,0,0]} barSize={22}/>
                <Bar dataKey="confirmados" fill={T.primary500} radius={[4,4,0,0]} barSize={22}/>
              </BarChart>
            </ResponsiveContainer>
            <div style={{ display:"flex",gap:16,marginTop:8 }}>
              <div style={{ display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400 }}><div style={{ width:10,height:10,borderRadius:3,background:T.n200 }}/> Total</div>
              <div style={{ display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400 }}><div style={{ width:10,height:10,borderRadius:3,background:T.primary500 }}/> Confirmados</div>
            </div>
          </div>

          {/* Overdue */}
          <div style={{ background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowSoft,border:`1px solid ${T.n200}`,overflow:"hidden",animation:"fadeSlideUp 0.4s ease 0.3s both" }}>
            <div style={{ padding:"18px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",borderBottom:`1px solid ${T.n200}` }}>
              <div style={{ display:"flex",alignItems:"center",gap:10 }}>
                <h2 style={{ fontSize:16,fontWeight:600 }}>CobranÃ§as atrasadas</h2>
                <span style={{ background:"rgba(220,38,38,0.08)",color:T.error,fontSize:12,fontWeight:600,padding:"3px 9px",borderRadius:10 }}>{MOCK_OVERDUE.length}</span>
              </div>
            </div>
            {MOCK_OVERDUE.map((inv,i)=>(
              <div key={i} style={{ padding:"14px 20px",borderBottom:`1px solid ${T.n100}`,display:"flex",alignItems:"center",gap:12,transition:"background 150ms",cursor:"pointer" }}
                onMouseEnter={e=>e.currentTarget.style.background=T.n100} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <div style={{ width:38,height:38,borderRadius:"50%",background:"rgba(220,38,38,0.08)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0 }}><DollarSign size={16} color={T.error}/></div>
                <div style={{ flex:1,minWidth:0 }}>
                  <div style={{ fontSize:13,fontWeight:500,color:T.n900 }}>{inv.patient}</div>
                  <div style={{ fontSize:12,color:T.n400,marginTop:1 }}>{inv.service} Â· Venc. {inv.dueDate}</div>
                </div>
                <div style={{ fontSize:14,fontWeight:700,color:T.error,flexShrink:0 }}>R$ {inv.amount}</div>
              </div>
            ))}
            <div onClick={()=>navigate('financeiro')} style={{ padding:"12px 20px",textAlign:"center",fontSize:13,color:T.primary500,fontWeight:500,cursor:"pointer",transition:"background 150ms" }}
              onMouseEnter={e=>e.currentTarget.style.background=T.n100} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
              Ver todas as cobranÃ§as â†’
            </div>
          </div>

          {/* Quick actions */}
          <div style={{ background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowSoft,border:`1px solid ${T.n200}`,padding:"20px",animation:"fadeSlideUp 0.4s ease 0.35s both" }}>
            <h2 style={{ fontSize:16,fontWeight:600,marginBottom:14 }}>AÃ§Ãµes rÃ¡pidas</h2>
            <div style={{ display:"flex",flexDirection:"column",gap:8 }}>
              {[
                { icon:Calendar,label:"Novo agendamento",color:T.primary500,page:'agenda' },
                { icon:Users,label:"Cadastrar paciente",color:T.success,page:'pacientes' },
                { icon:DollarSign,label:"Gerar fatura",color:T.warning,page:'financeiro' },
                { icon:MessageSquare,label:"Enviar mensagem",color:T.info,page:'mensagens' },
              ].map((a,i)=>(
                <button key={i} onClick={()=>navigate(a.page)} style={{ display:"flex",alignItems:"center",gap:12,padding:"12px 14px",borderRadius:T.radiusMd,border:`1px solid ${T.n200}`,background:T.n0,cursor:"pointer",fontFamily:T.font,fontSize:13,fontWeight:500,color:T.n900,transition:"all 150ms",width:"100%",textAlign:"left" }}
                  onMouseEnter={e=>{e.currentTarget.style.background=T.n100;e.currentTarget.style.borderColor=T.n300}} onMouseLeave={e=>{e.currentTarget.style.background=T.n0;e.currentTarget.style.borderColor=T.n200}}>
                  <div style={{ width:32,height:32,borderRadius:8,background:`${a.color}12`,display:"flex",alignItems:"center",justifyContent:"center" }}><a.icon size={15} color={a.color}/></div>
                  {a.label}
                  <ArrowUpRight size={14} color={T.n400} style={{ marginLeft:"auto" }}/>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

