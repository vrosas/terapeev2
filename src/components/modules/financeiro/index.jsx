import { useState, useMemo, useEffect } from 'react'
import { AlertCircle, ArrowDownRight, ArrowUpRight, Ban, BarChart3, Building2, Calendar, Check, CheckCircle2, ChevronDown, Clock, CreditCard, DollarSign, Download, Edit3, Eye, FileBarChart, FileText, Filter, Hash, Home, Loader2, MoreHorizontal, Package, Phone, PiggyBank, Plus, Printer, Receipt, RefreshCw, Repeat, Search, Send, Settings, Shield, ShoppingCart, Tag, Trash2, TrendingDown, TrendingUp, Truck, Users, Wallet, Wifi, Wrench, X, Zap } from 'lucide-react'
import {
  BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer,
  AreaChart, Area, CartesianGrid, PieChart as RPie, Pie, Cell,
} from 'recharts'
import { T } from '@/utils/theme'

import { Button, Modal, InputField, SelectField, Badge, Card, StatCard, EmptyState, LoadingSpinner, getInitials } from '@/components/ui'
import { useCharges, useExpenses, useExpenseCategories, usePatients, useProfessionals, useSuppliers } from '@/lib/hooks'

/* ─── Form Style Constants ─── */
const IS = { width:"100%",padding:"10px 14px",borderRadius:8,border:`1.5px solid ${T.n300}`,fontFamily:T.font,fontSize:13,color:T.n900,background:T.n0,outline:"none",transition:"border 200ms" };
const LS = { display:"block",fontSize:12,fontWeight:500,color:T.n400,marginBottom:4 };
const FW = { marginBottom:16 };

/* ─── Chart Tooltip ─── */
function CustomTooltip({active,payload,label}){if(!active||!payload?.length)return null;return(<div style={{background:T.n0,border:`1px solid ${T.n200}`,borderRadius:8,padding:"10px 14px",boxShadow:T.shadowSm}}><div style={{fontSize:12,fontWeight:600,color:T.n900,marginBottom:4}}>{label}</div>{payload.map((p,i)=>(<div key={i} style={{fontSize:12,color:p.color||T.n700,display:"flex",alignItems:"center",gap:6}}><div style={{width:8,height:8,borderRadius:2,background:p.color}}/>{p.name}: <strong>R$ {Number(p.value).toLocaleString("pt-BR")}</strong></div>))}</div>)}

const COB_STATUS = {
  aberto:{ label:"Aberto",color:T.warning,bg:"rgba(245,158,11,0.10)",icon:Clock },
  pago:{ label:"Pago",color:T.success,bg:"rgba(22,163,74,0.10)",icon:CheckCircle2 },
  atrasado:{ label:"Atrasado",color:T.error,bg:"rgba(220,38,38,0.10)",icon:AlertCircle },
  cancelado:{ label:"Cancelado",color:T.n400,bg:"rgba(201,205,216,0.15)",icon:Ban },
};
const DESP_STATUS = {
  pendente:{ label:"Pendente",color:T.warning,bg:"rgba(245,158,11,0.10)",icon:Clock },
  pago:{ label:"Pago",color:T.success,bg:"rgba(22,163,74,0.10)",icon:CheckCircle2 },
  atrasado:{ label:"Atrasado",color:T.error,bg:"rgba(220,38,38,0.10)",icon:AlertCircle },
  cancelado:{ label:"Cancelado",color:T.n400,bg:"rgba(201,205,216,0.15)",icon:Ban },
};
const EXPENSE_CATEGORIES = [
  { id:"aluguel",label:"Aluguel",icon:Home,color:T.primary500 },
  { id:"energia",label:"Energia elétrica",icon:Zap,color:T.warning },
  { id:"agua",label:"Água",icon:ShoppingCart,color:T.info },
  { id:"internet",label:"Internet / Telefonia",icon:Wifi,color:T.teal },
  { id:"material",label:"Material de escritório",icon:Package,color:T.orange },
  { id:"limpeza",label:"Limpeza e conservação",icon:Wrench,color:T.purple },
  { id:"software",label:"Software / Sistemas",icon:Settings,color:T.primary600 },
  { id:"manutencao",label:"Manutenção predial",icon:Wrench,color:T.n700 },
  { id:"marketing",label:"Marketing / Publicidade",icon:Truck,color:"#E11D48" },
  { id:"contabilidade",label:"Contabilidade",icon:FileBarChart,color:T.success },
  { id:"seguros",label:"Seguros",icon:Shield,color:T.info },
  { id:"outros",label:"Outros",icon:Tag,color:T.n400 },
];
const PAY_METHODS = ["Pix","Dinheiro","Cartão de Crédito","Cartão de Débito","Convênio","Transferência","Boleto"];




/* ═══ Sidebar ═══ */


/* ═══ Cobrança Modal ═══ */
function CobrancaModal({open,onClose,onCreate,rawPatients=[]}){const[form,setForm]=useState({patient:"",patient_id:"",service:"",description:"",amount:"",dueDate:"",method:"",recurrent:false});const[saving,setSaving]=useState(false);useEffect(()=>{if(open)setForm({patient:"",patient_id:"",service:"",description:"",amount:"",dueDate:"",method:"",recurrent:false})},[open]);const upd=(k,v)=>setForm(f=>({...f,[k]:v}));const hPatient=v=>{const found=rawPatients.find(p=>p.full_name===v);setForm(f=>({...f,patient:v,patient_id:found?.id||null}))};const hsc=v=>{setForm(f=>({...f,service:v,description:v?`${v} — Sessão`:f.description}))};const save=async()=>{if(!form.amount||!form.dueDate)return;setSaving(true);const{error}=await (onCreate?.({amount:parseFloat(form.amount)||0,due_date:form.dueDate,description:form.description||form.service,payment_method:form.method||null,status:'pending',patient_id:form.patient_id||null})??Promise.resolve({}));setSaving(false);if(!error)onClose("saved")};if(!open)return null;return(<div onClick={()=>onClose()} style={{position:"fixed",inset:0,background:"rgba(17,17,17,0.4)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)",animation:"fadeIn 150ms ease"}}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:540,background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowLg,overflow:"hidden",animation:"slideUp 250ms ease",maxHeight:"90vh",display:"flex",flexDirection:"column"}}><div style={{padding:"20px 24px",borderBottom:`1px solid ${T.n200}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><h2 style={{fontSize:18,fontWeight:700}}>Nova cobrança</h2><button onClick={()=>onClose()} style={{width:32,height:32,borderRadius:8,border:"none",cursor:"pointer",background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400}}><X size={18}/></button></div><div style={{padding:"20px 24px",overflowY:"auto",flex:1}}><div style={FW}><label style={LS}>Paciente *</label><select value={form.patient} onChange={e=>hPatient(e.target.value)} style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar paciente...</option>{rawPatients.map(p=><option key={p.id} value={p.full_name}>{p.full_name}</option>)}</select></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>Serviço *</label><select value={form.service} onChange={e=>hsc(e.target.value)} style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar...</option>{([]).map(s=><option key={s.name} value={s.name}>{s.name} (R$ {s.price})</option>)}</select></div><div style={FW}><label style={LS}>Profissional</label><select style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar...</option>{professionalNames.map(p=><option key={p} value={p}>{p}</option>)}</select></div></div><div style={FW}><label style={LS}>Descrição</label><input value={form.description} onChange={e=>upd("description",e.target.value)} placeholder="Ex: Psicoterapia — Sessão individual" style={IS}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>Valor (R$) *</label><div style={{position:"relative"}}><span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",fontSize:14,color:T.n400,fontWeight:500}}>R$</span><input type="number" value={form.amount} onChange={e=>upd("amount",e.target.value)} placeholder="0,00" style={{...IS,paddingLeft:38}}/></div></div><div style={FW}><label style={LS}>Vencimento *</label><input type="date" value={form.dueDate} onChange={e=>upd("dueDate",e.target.value)} style={IS}/></div></div><div style={FW}><label style={LS}>Forma de pagamento</label><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{PAY_METHODS.slice(0,6).map(m=>(<button key={m} onClick={()=>upd("method",form.method===m?"":m)} style={{padding:"7px 14px",borderRadius:20,cursor:"pointer",border:`1.5px solid ${form.method===m?T.primary500:T.n300}`,background:form.method===m?T.primary50:T.n0,color:form.method===m?T.primary500:T.n700,fontFamily:T.font,fontSize:12,fontWeight:500,transition:"all 200ms"}}>{m}</button>))}</div></div><div style={{display:"flex",alignItems:"center",gap:10,padding:"14px 16px",background:T.n100,borderRadius:T.radiusMd,border:`1px solid ${T.n200}`}}><button onClick={()=>upd("recurrent",!form.recurrent)} style={{width:40,height:22,borderRadius:11,border:"none",cursor:"pointer",background:form.recurrent?T.primary500:T.n300,position:"relative",transition:"background 200ms",flexShrink:0}}><div style={{width:18,height:18,borderRadius:"50%",background:T.n0,position:"absolute",top:2,left:form.recurrent?20:2,transition:"left 200ms",boxShadow:"0 1px 3px rgba(0,0,0,0.15)"}}/></button><div><div style={{fontSize:13,fontWeight:500,color:T.n900}}>Cobrança recorrente</div><div style={{fontSize:12,color:T.n400}}>Gerar automaticamente a cada ciclo</div></div></div></div><div style={{padding:"16px 24px",borderTop:`1px solid ${T.n200}`,display:"flex",justifyContent:"space-between"}}><button onClick={()=>onClose()} style={{padding:"11px 18px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,color:T.n700,fontFamily:T.font,fontSize:14,fontWeight:500,cursor:"pointer"}}>Cancelar</button><button onClick={save} disabled={saving} style={{padding:"11px 20px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,opacity:saving?0.7:1,transition:"all 200ms"}} onMouseEnter={e=>{if(!saving)e.currentTarget.style.background=T.primary600}} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}>{saving?<Loader2 size={15} className="spin"/>:<Check size={15}/>} Criar cobrança</button></div></div></div>)}

/* ═══ Despesa Modal ═══ */
function DespesaModal({open,onClose,expense,onCreate,onUpdate}){const isEdit=!!expense;const[form,setForm]=useState({description:"",category:"",supplier:"",amount:"",dueDate:"",method:"",recurrent:false,recurrenceType:"mensal",notes:""});const[saving,setSaving]=useState(false);useEffect(()=>{if(open&&expense)setForm({description:expense.description,category:expense.category,supplier:expense.supplier,amount:String(expense.amount),dueDate:expense.dueDate,method:expense.method||"",recurrent:expense.recurrent,recurrenceType:expense.recurrenceType||"mensal",notes:""});else if(open)setForm({description:"",category:"",supplier:"",amount:"",dueDate:"",method:"",recurrent:false,recurrenceType:"mensal",notes:""})},[open,expense]);const upd=(k,v)=>setForm(f=>({...f,[k]:v}));const save=async()=>{if(!form.description||!form.amount)return;setSaving(true);const RMAP={mensal:"monthly",trimestral:"quarterly",semestral:"yearly",anual:"yearly"};const payload={description:form.description,amount:parseFloat(form.amount)||0,date:form.dueDate,recurrence:form.recurrent?(RMAP[form.recurrenceType]||"monthly"):null,notes:form.notes||null};const{error}=isEdit?await(onUpdate?.(expense.id,payload)??Promise.resolve({})):await(onCreate?.(payload)??Promise.resolve({}));setSaving(false);if(!error)onClose("saved")};if(!open)return null;return(<div onClick={()=>onClose()} style={{position:"fixed",inset:0,background:"rgba(17,17,17,0.4)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)",animation:"fadeIn 150ms ease"}}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:560,background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowLg,overflow:"hidden",animation:"slideUp 250ms ease",maxHeight:"92vh",display:"flex",flexDirection:"column"}}><div style={{padding:"20px 24px",borderBottom:`1px solid ${T.n200}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><h2 style={{fontSize:18,fontWeight:700}}>{isEdit?"Editar despesa":"Nova despesa"}</h2><button onClick={()=>onClose()} style={{width:32,height:32,borderRadius:8,border:"none",cursor:"pointer",background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400}}><X size={18}/></button></div><div style={{padding:"20px 24px",overflowY:"auto",flex:1}}><div style={FW}><label style={LS}>Descrição *</label><input value={form.description} onChange={e=>upd("description",e.target.value)} placeholder="Ex: Aluguel sala comercial — Janeiro" style={IS}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>Categoria *</label><select value={form.category} onChange={e=>upd("category",e.target.value)} style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar...</option>{EXPENSE_CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}</select></div><div style={FW}><label style={LS}>Fornecedor / Credor</label><select value={form.supplier} onChange={e=>upd("supplier",e.target.value)} style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar...</option>{suppliers.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}<option value="__new">+ Cadastrar novo</option></select></div></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>Valor (R$) *</label><div style={{position:"relative"}}><span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",fontSize:14,color:T.n400,fontWeight:500}}>R$</span><input type="number" value={form.amount} onChange={e=>upd("amount",e.target.value)} placeholder="0,00" style={{...IS,paddingLeft:38}}/></div></div><div style={FW}><label style={LS}>Vencimento *</label><input type="date" value={form.dueDate} onChange={e=>upd("dueDate",e.target.value)} style={IS}/></div></div><div style={FW}><label style={LS}>Forma de pagamento</label><div style={{display:"flex",gap:8,flexWrap:"wrap"}}>{PAY_METHODS.map(m=>(<button key={m} onClick={()=>upd("method",form.method===m?"":m)} style={{padding:"7px 14px",borderRadius:20,cursor:"pointer",border:`1.5px solid ${form.method===m?T.primary500:T.n300}`,background:form.method===m?T.primary50:T.n0,color:form.method===m?T.primary500:T.n700,fontFamily:T.font,fontSize:12,fontWeight:500,transition:"all 200ms"}}>{m}</button>))}</div></div><div style={{padding:"14px 16px",background:T.n100,borderRadius:T.radiusMd,border:`1px solid ${T.n200}`,marginBottom:16}}><div style={{display:"flex",alignItems:"center",gap:10,marginBottom:form.recurrent?12:0}}><button onClick={()=>upd("recurrent",!form.recurrent)} style={{width:40,height:22,borderRadius:11,border:"none",cursor:"pointer",background:form.recurrent?T.primary500:T.n300,position:"relative",transition:"background 200ms",flexShrink:0}}><div style={{width:18,height:18,borderRadius:"50%",background:T.n0,position:"absolute",top:2,left:form.recurrent?20:2,transition:"left 200ms",boxShadow:"0 1px 3px rgba(0,0,0,0.15)"}}/></button><div><div style={{fontSize:13,fontWeight:500,color:T.n900}}>Despesa recorrente</div><div style={{fontSize:12,color:T.n400}}>Gerar automaticamente a cada ciclo</div></div></div>{form.recurrent&&<div style={{display:"flex",gap:8}}>{["mensal","trimestral","semestral","anual"].map(r=>(<button key={r} onClick={()=>upd("recurrenceType",r)} style={{padding:"6px 12px",borderRadius:20,cursor:"pointer",border:`1.5px solid ${form.recurrenceType===r?T.primary500:T.n300}`,background:form.recurrenceType===r?T.primary50:T.n0,color:form.recurrenceType===r?T.primary500:T.n400,fontFamily:T.font,fontSize:12,fontWeight:500,transition:"all 200ms",textTransform:"capitalize"}}>{r}</button>))}</div>}</div><div style={FW}><label style={LS}>Observações</label><textarea value={form.notes} onChange={e=>upd("notes",e.target.value)} placeholder="Notas adicionais..." style={{...IS,minHeight:60,resize:"vertical"}}/></div></div><div style={{padding:"16px 24px",borderTop:`1px solid ${T.n200}`,display:"flex",justifyContent:"space-between"}}><button onClick={()=>onClose()} style={{padding:"11px 18px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,color:T.n700,fontFamily:T.font,fontSize:14,fontWeight:500,cursor:"pointer"}}>Cancelar</button><button onClick={save} disabled={saving} style={{padding:"11px 20px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,opacity:saving?0.7:1,transition:"all 200ms"}} onMouseEnter={e=>{if(!saving)e.currentTarget.style.background=T.primary600}} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}>{saving?<Loader2 size={15} className="spin"/>:<Check size={15}/>} {isEdit?"Salvar":"Registrar despesa"}</button></div></div></div>)}

/* ═══ Supplier Modal ═══ */
function SupplierModal({open,onClose,supplier,onCreate,onUpdate}){const isEdit=!!supplier;const[form,setForm]=useState({name:"",cnpj:"",phone:"",email:"",category:"",address:"",notes:""});const[saving,setSaving]=useState(false);useEffect(()=>{if(open&&supplier)setForm({name:supplier.name,cnpj:supplier.cnpj,phone:supplier.phone,email:supplier.email,category:supplier.category,address:supplier.address,notes:supplier.notes});else if(open)setForm({name:"",cnpj:"",phone:"",email:"",category:"",address:"",notes:""})},[open,supplier]);const upd=(k,v)=>setForm(f=>({...f,[k]:v}));const save=async()=>{if(!form.name.trim())return;setSaving(true);const payload={name:form.name,cnpj:form.cnpj||null,phone:form.phone||null,email:form.email||null,address:form.address||null,notes:form.notes||null};const{error}=isEdit?await(onUpdate?.(supplier.id,payload)??Promise.resolve({})):await(onCreate?.(payload)??Promise.resolve({}));setSaving(false);if(!error)onClose("saved")};if(!open)return null;return(<div onClick={()=>onClose()} style={{position:"fixed",inset:0,background:"rgba(17,17,17,0.4)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(4px)",animation:"fadeIn 150ms ease"}}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:520,background:T.n0,borderRadius:T.radiusLg,boxShadow:T.shadowLg,overflow:"hidden",animation:"slideUp 250ms ease",maxHeight:"90vh",display:"flex",flexDirection:"column"}}><div style={{padding:"20px 24px",borderBottom:`1px solid ${T.n200}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><h2 style={{fontSize:18,fontWeight:700}}>{isEdit?"Editar fornecedor":"Novo fornecedor"}</h2><button onClick={()=>onClose()} style={{width:32,height:32,borderRadius:8,border:"none",cursor:"pointer",background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400}}><X size={18}/></button></div><div style={{padding:"20px 24px",overflowY:"auto",flex:1}}><div style={FW}><label style={LS}>Nome / Razão Social *</label><input value={form.name} onChange={e=>upd("name",e.target.value)} placeholder="Nome do fornecedor" style={IS}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>CNPJ</label><input value={form.cnpj} onChange={e=>upd("cnpj",e.target.value)} placeholder="00.000.000/0000-00" style={IS}/></div><div style={FW}><label style={LS}>Categoria</label><select value={form.category} onChange={e=>upd("category",e.target.value)} style={{...IS,cursor:"pointer",appearance:"auto"}}><option value="">Selecionar...</option>{EXPENSE_CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}</select></div></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}><div style={FW}><label style={LS}>Telefone</label><input value={form.phone} onChange={e=>upd("phone",e.target.value)} placeholder="(11) 99999-9999" style={IS}/></div><div style={FW}><label style={LS}>E-mail</label><input value={form.email} onChange={e=>upd("email",e.target.value)} placeholder="contato@empresa.com" style={IS}/></div></div><div style={FW}><label style={LS}>Endereço</label><input value={form.address} onChange={e=>upd("address",e.target.value)} placeholder="Endereço completo" style={IS}/></div><div style={FW}><label style={LS}>Observações</label><textarea value={form.notes} onChange={e=>upd("notes",e.target.value)} placeholder="Dados contratuais, notas..." style={{...IS,minHeight:60,resize:"vertical"}}/></div></div><div style={{padding:"16px 24px",borderTop:`1px solid ${T.n200}`,display:"flex",justifyContent:"space-between"}}><button onClick={()=>onClose()} style={{padding:"11px 18px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,color:T.n700,fontFamily:T.font,fontSize:14,fontWeight:500,cursor:"pointer"}}>Cancelar</button><button onClick={save} disabled={saving} style={{padding:"11px 20px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,opacity:saving?0.7:1,transition:"all 200ms"}} onMouseEnter={e=>{if(!saving)e.currentTarget.style.background=T.primary600}} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}>{saving?<Loader2 size={15} className="spin"/>:<Check size={15}/>} {isEdit?"Salvar":"Cadastrar"}</button></div></div></div>)}

/* ═══ MAIN CONTENT ═══ */
export default function Financeiro(){
/* ─── Hooks ─── */
const { data: rawCharges, loading: chargesLoading, create: createCharge } = useCharges();
const { data: rawExpenses, loading: expensesLoading, create: createExpense, update: updateExpense } = useExpenses();
const { data: rawPatients } = usePatients();
const { data: rawProfessionals } = useProfessionals();
const { data: rawSuppliers, create: createSupplier, update: updateSupplier } = useSuppliers();

/* ─── Adapt suppliers from hook ─── */
const suppliers = useMemo(() => rawSuppliers.map(s => ({
  id: s.id, name: s.name, cnpj: s.cnpj || "", phone: s.phone || "",
  email: s.email || "", category: s.category?.name || "",
  notes: s.notes || "", totalPaid: 0,
})), [rawSuppliers]);

/* ─── Compute cashflow from real charges + expenses (last 6 months) ─── */
const MONTH_NAMES = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
const cashflowData = useMemo(() => {
  const now = new Date();
  const months = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${d.getFullYear()}-${d.getMonth()}`;
    const nextMonth = new Date(d.getFullYear(), d.getMonth() + 1, 1);
    const receita = rawCharges.filter(c => c.status === "paid" && c.paid_at && new Date(c.paid_at) >= d && new Date(c.paid_at) < nextMonth).reduce((s, c) => s + (c.amount || 0), 0);
    const despesa = rawExpenses.filter(e => e.date && new Date(e.date) >= d && new Date(e.date) < nextMonth).reduce((s, e) => s + (e.amount || 0), 0);
    months.push({ month: MONTH_NAMES[d.getMonth()], receita: receita || 0, despesa: despesa || 0 });
  }
  return months;
}, [rawCharges, rawExpenses]);

/* ─── Revenue by service (from charge descriptions) ─── */
const SVC_COLORS = [T.primary500, T.success, T.warning, T.purple, T.teal, T.pink];
const byServiceData = useMemo(() => {
  const map = {};
  rawCharges.filter(c => c.status === "paid").forEach(c => {
    const svc = (c.description || "Outros").split("—")[0].trim().split(" ")[0];
    map[svc] = (map[svc] || 0) + (c.amount || 0);
  });
  return Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, value], i) => ({
    name, value, color: SVC_COLORS[i % SVC_COLORS.length],
  }));
}, [rawCharges]);

/* ─── Adapt hook data → UI shape ─── */
const CHSTATUS = { paid:"pago", pending:"aberto", overdue:"atrasado", cancelled:"cancelado" };
const cobrancas = useMemo(() => rawCharges.map(c => ({
  id: c.id, patient: c.patient?.full_name || "", description: c.description || "Sessão",
  service: c.description?.split("—")[0]?.trim() || "", professional: c.professional?.full_name || "",
  amount: c.amount || 0, status: CHSTATUS[c.status] || c.status,
  dueDate: c.due_date || "", paidDate: c.paid_at ? c.paid_at.split("T")[0] : null,
  method: c.payment_method || null, convenio: null,
})), [rawCharges]);
const despesas = useMemo(() => rawExpenses.map(e => ({
  id: e.id, description: e.description || "", category: e.category?.name || e.category_id || "",
  supplier: "", amount: e.amount || 0, status: "pago",
  dueDate: e.date || "", recurrent: e.recurrence === "monthly", recurrenceType: e.recurrence || "mensal",
  method: null,
})), [rawExpenses]);
const patientNames = useMemo(() => rawPatients.map(p => p.full_name), [rawPatients]);
const professionalNames = useMemo(() => rawProfessionals.map(p => p.full_name), [rawProfessionals]);
const[tab,setTab]=useState("overview");const[search,setSearch]=useState("");const[statusFilter,setStatusFilter]=useState("all");const[catFilter,setCatFilter]=useState("all");const[typeFilter,setTypeFilter]=useState("all");const[cobModal,setCobModal]=useState(false);const[despModal,setDespModal]=useState(false);const[editDesp,setEditDesp]=useState(null);const[supModal,setSupModal]=useState(false);const[editSup,setEditSup]=useState(null);
const cobStats=useMemo(()=>{const paid=cobrancas.filter(i=>i.status==="pago").reduce((s,i)=>s+i.amount,0);const open=cobrancas.filter(i=>i.status==="aberto").reduce((s,i)=>s+i.amount,0);const overdue=cobrancas.filter(i=>i.status==="atrasado").reduce((s,i)=>s+i.amount,0);return{paid,open,overdue,overdueCount:cobrancas.filter(i=>i.status==="atrasado").length}},[]);
const despStats=useMemo(()=>{const paid=despesas.filter(d=>d.status==="pago").reduce((s,d)=>s+d.amount,0);const pending=despesas.filter(d=>d.status==="pendente"||d.status==="atrasado").reduce((s,d)=>s+d.amount,0);const recurrent=despesas.filter(d=>d.recurrent).reduce((s,d)=>s+d.amount,0);return{paid,pending,recurrent,total:paid+pending}},[]);
const filteredCob=useMemo(()=>cobrancas.filter(i=>{const ms=!search||i.patient.toLowerCase().includes(search.toLowerCase())||i.id.toLowerCase().includes(search.toLowerCase());const mst=statusFilter==="all"||i.status===statusFilter;return ms&&mst}).sort((a,b)=>new Date(b.dueDate)-new Date(a.dueDate)),[search,statusFilter]);
const filteredDesp=useMemo(()=>despesas.filter(d=>{const ms=!search||d.description.toLowerCase().includes(search.toLowerCase())||d.supplier.toLowerCase().includes(search.toLowerCase());const mst=statusFilter==="all"||d.status===statusFilter;const mc=catFilter==="all"||d.category===catFilter;const mt=typeFilter==="all"||(typeFilter==="recorrente"?d.recurrent:!d.recurrent);return ms&&mst&&mc&&mt}).sort((a,b)=>new Date(b.dueDate)-new Date(a.dueDate)),[search,statusFilter,catFilter,typeFilter]);
const resetFilters=()=>{setSearch("");setStatusFilter("all");setCatFilter("all");setTypeFilter("all")};
const tabs=[{id:"overview",label:"Visão geral",icon:BarChart3},{id:"cobrancas",label:"Cobranças",icon:Receipt},{id:"despesas",label:"Despesas",icon:ShoppingCart},{id:"fornecedores",label:"Fornecedores",icon:Building2}];
return(<div style={{padding:"24px 28px",maxWidth:1320}}>
{/* Header */}
<div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20,animation:"fadeSlideUp 0.3s ease both"}}><div><h1 style={{fontSize:22,fontWeight:700}}>Financeiro</h1><p style={{fontSize:13,color:T.n400,marginTop:2}}>Cobranças, despesas e fluxo de caixa</p></div><div style={{display:"flex",gap:8}}><button style={{padding:"9px 16px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,color:T.n700,fontFamily:T.font,fontSize:13,fontWeight:500,cursor:"pointer",display:"flex",alignItems:"center",gap:5}}><Download size={14}/> Exportar</button>{(tab==="cobrancas"||tab==="overview")&&<button onClick={()=>setCobModal(true)} style={{padding:"9px 18px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,transition:"all 200ms"}} onMouseEnter={e=>e.currentTarget.style.background=T.primary600} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}><Plus size={16}/> Nova cobrança</button>}{tab==="despesas"&&<button onClick={()=>{setEditDesp(null);setDespModal(true)}} style={{padding:"9px 18px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,transition:"all 200ms"}} onMouseEnter={e=>e.currentTarget.style.background=T.primary600} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}><Plus size={16}/> Nova despesa</button>}{tab==="fornecedores"&&<button onClick={()=>{setEditSup(null);setSupModal(true)}} style={{padding:"9px 18px",borderRadius:T.radiusMd,border:"none",background:T.primary500,color:T.n0,fontFamily:T.font,fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6,transition:"all 200ms"}} onMouseEnter={e=>e.currentTarget.style.background=T.primary600} onMouseLeave={e=>e.currentTarget.style.background=T.primary500}><Plus size={16}/> Novo fornecedor</button>}</div></div>
{/* Stats */}
<div style={{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:14,marginBottom:24}}><StatCard icon={Wallet} label="Recebido (cobranças)" value={`R$ ${cobStats.paid.toLocaleString("pt-BR")}`} trend="+12%" trendUp color={T.success} delay={0.05}/><StatCard icon={AlertCircle} label="Cobranças atrasadas" value={`R$ ${cobStats.overdue.toLocaleString("pt-BR")}`} sub={`${cobStats.overdueCount} cobranças vencidas`} color={T.error} delay={0.1}/><StatCard icon={ShoppingCart} label="Despesas do mês" value={`R$ ${despStats.total.toLocaleString("pt-BR")}`} sub={`R$ ${despStats.recurrent.toLocaleString("pt-BR")} recorrentes`} color={T.orange} delay={0.15}/><StatCard icon={TrendingUp} label="Saldo do período" value={`R$ ${(cobStats.paid-despStats.paid).toLocaleString("pt-BR")}`} sub="Receita - Despesas (Jan)" trend="+5%" trendUp color={T.primary500} delay={0.2}/></div>
{/* Tabs */}
<div style={{display:"flex",gap:0,borderBottom:`2px solid ${T.n200}`,marginBottom:20}}>{tabs.map(t=>{const active=tab===t.id;return<button key={t.id} onClick={()=>{setTab(t.id);resetFilters()}} style={{display:"flex",alignItems:"center",gap:6,padding:"12px 20px",border:"none",cursor:"pointer",fontFamily:T.font,fontSize:14,fontWeight:active?600:400,color:active?T.primary500:T.n400,background:"transparent",borderBottom:`2px solid ${active?T.primary500:"transparent"}`,marginBottom:-2,transition:"all 150ms"}}><t.icon size={16}/> {t.label}</button>})}</div>

{/* OVERVIEW */}
{tab==="overview"&&<div style={{display:"grid",gridTemplateColumns:"1fr 360px",gap:20,animation:"fadeSlideUp 0.35s ease both"}}><div style={{display:"flex",flexDirection:"column",gap:20}}><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,padding:"20px 24px"}}><h2 style={{fontSize:16,fontWeight:600,marginBottom:4}}>Fluxo de caixa</h2><div style={{fontSize:13,color:T.n400,marginBottom:16}}>Últimos 6 meses</div><ResponsiveContainer width="100%" height={220}><AreaChart data={cashflowData} margin={{top:5,right:5,bottom:0,left:-10}}><defs><linearGradient id="gR" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={T.success} stopOpacity={0.12}/><stop offset="95%" stopColor={T.success} stopOpacity={0}/></linearGradient><linearGradient id="gD" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={T.error} stopOpacity={0.08}/><stop offset="95%" stopColor={T.error} stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke={T.n200} vertical={false}/><XAxis dataKey="month" axisLine={false} tickLine={false} tick={{fontSize:12,fill:T.n400}}/><YAxis axisLine={false} tickLine={false} tick={{fontSize:11,fill:T.n400}} tickFormatter={v=>`${(v/1000).toFixed(0)}k`}/><Tooltip content={<CustomTooltip/>}/><Area type="monotone" dataKey="receita" stroke={T.success} strokeWidth={2.5} fill="url(#gR)" dot={{fill:T.success,r:4,strokeWidth:0}}/><Area type="monotone" dataKey="despesa" stroke={T.error} strokeWidth={2} strokeDasharray="6 3" fill="url(#gD)" dot={false}/></AreaChart></ResponsiveContainer><div style={{display:"flex",gap:20,marginTop:8}}><div style={{display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400}}><div style={{width:12,height:3,borderRadius:2,background:T.success}}/> Receita</div><div style={{display:"flex",alignItems:"center",gap:6,fontSize:12,color:T.n400}}><div style={{width:12,height:3,borderRadius:2,background:T.error,opacity:0.6}}/> Despesas</div></div></div><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,padding:"20px 24px"}}><h2 style={{fontSize:16,fontWeight:600,marginBottom:4}}>Receita por serviço</h2><div style={{fontSize:13,color:T.n400,marginBottom:16}}>Janeiro 2025</div><ResponsiveContainer width="100%" height={180}><BarChart data={byServiceData} layout="vertical" margin={{top:0,right:0,bottom:0,left:0}}><XAxis type="number" axisLine={false} tickLine={false} tick={{fontSize:11,fill:T.n400}} tickFormatter={v=>`${(v/1000).toFixed(0)}k`}/><YAxis type="category" dataKey="name" axisLine={false} tickLine={false} tick={{fontSize:12,fill:T.n700}} width={120}/><Tooltip content={<CustomTooltip/>}/><Bar dataKey="value" radius={[0,6,6,0]} barSize={22}>{byServiceData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Bar></BarChart></ResponsiveContainer></div></div><div style={{display:"flex",flexDirection:"column",gap:20}}><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,padding:"20px 24px"}}><h2 style={{fontSize:16,fontWeight:600,marginBottom:16}}>Status das cobranças</h2><ResponsiveContainer width="100%" height={180}><RPie><Pie data={[{name:"Pago",value:cobStats.paid,fill:T.success},{name:"Aberto",value:cobStats.open,fill:T.warning},{name:"Atrasado",value:cobStats.overdue,fill:T.error}]} cx="50%" cy="50%" innerRadius={50} outerRadius={75} paddingAngle={4} dataKey="value"/><Tooltip content={<CustomTooltip/>}/></RPie></ResponsiveContainer><div style={{display:"flex",flexDirection:"column",gap:8,marginTop:8}}>{[{label:"Pago",value:cobStats.paid,color:T.success},{label:"Aberto",value:cobStats.open,color:T.warning},{label:"Atrasado",value:cobStats.overdue,color:T.error}].map((s,i)=>(<div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><div style={{display:"flex",alignItems:"center",gap:8,fontSize:13,color:T.n700}}><div style={{width:10,height:10,borderRadius:3,background:s.color}}/> {s.label}</div><span style={{fontSize:14,fontWeight:600}}>R$ {s.value.toLocaleString("pt-BR")}</span></div>))}</div></div><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,padding:"20px 24px"}}><h2 style={{fontSize:16,fontWeight:600,marginBottom:12}}>Despesas por categoria</h2>{EXPENSE_CATEGORIES.filter(c=>despesas.some(d=>d.category===c.id)).slice(0,6).map(cat=>{const total=despesas.filter(d=>d.category===cat.id).reduce((s,d)=>s+d.amount,0);const pct=Math.round((total/despStats.total)*100);const Icon=cat.icon;return(<div key={cat.id} style={{marginBottom:12}}><div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4}}><div style={{display:"flex",alignItems:"center",gap:6,fontSize:13,color:T.n700}}><Icon size={13} color={cat.color}/> {cat.label}</div><span style={{fontSize:13,fontWeight:600}}>R$ {total.toLocaleString("pt-BR")}</span></div><div style={{height:6,background:T.n200,borderRadius:3,overflow:"hidden"}}><div style={{height:"100%",width:`${pct}%`,background:cat.color,borderRadius:3,transition:"width 600ms ease"}}/></div></div>)})}</div></div></div>}

{/* COBRANÇAS */}
{tab==="cobrancas"&&<div style={{animation:"fadeSlideUp 0.3s ease both"}}><div style={{display:"flex",alignItems:"center",gap:10,marginBottom:16}}><div style={{flex:1,maxWidth:340,display:"flex",alignItems:"center",border:`1.5px solid ${T.n300}`,borderRadius:T.radiusMd,background:T.n0,overflow:"hidden"}}><span style={{paddingLeft:12,color:T.n400,display:"flex"}}><Search size={16}/></span><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar paciente ou nº..." style={{flex:1,border:"none",outline:"none",padding:"10px 12px",fontSize:13,fontFamily:T.font,color:T.n900,background:"transparent"}}/>{search&&<button onClick={()=>setSearch("")} style={{border:"none",background:"none",cursor:"pointer",padding:"0 10px",color:T.n400,display:"flex"}}><X size={14}/></button>}</div><div style={{display:"flex",gap:6}}>{[{id:"all",label:"Todos"},{id:"aberto",label:"Abertos",color:T.warning},{id:"pago",label:"Pagos",color:T.success},{id:"atrasado",label:"Atrasados",color:T.error},{id:"cancelado",label:"Cancelados",color:T.n400}].map(f=>(<button key={f.id} onClick={()=>setStatusFilter(f.id)} style={{padding:"7px 14px",borderRadius:20,cursor:"pointer",border:`1.5px solid ${statusFilter===f.id?(f.color||T.primary500):T.n300}`,background:statusFilter===f.id?(f.color?`${f.color}12`:T.primary50):T.n0,color:statusFilter===f.id?(f.color||T.primary500):T.n400,fontFamily:T.font,fontSize:12,fontWeight:500,transition:"all 200ms"}}>{f.label}</button>))}</div><span style={{fontSize:12,color:T.n400,marginLeft:"auto"}}>{filteredCob.length} cobranças</span></div><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,overflow:"hidden"}}><div style={{display:"grid",gridTemplateColumns:"90px 1.5fr 1.5fr 0.8fr 0.8fr 0.7fr 44px",padding:"12px 20px",background:T.n100,borderBottom:`1px solid ${T.n200}`,gap:12,alignItems:"center"}}>{["Nº","Paciente","Descrição","Valor","Vencimento","Status",""].map((h,i)=><span key={i} style={{fontSize:12,fontWeight:600,color:T.n400,textTransform:"uppercase",letterSpacing:"0.04em"}}>{h}</span>)}</div>{filteredCob.map((inv,i)=>{const st=COB_STATUS[inv.status];const StIcon=st.icon;return(<div key={inv.id} style={{display:"grid",gridTemplateColumns:"90px 1.5fr 1.5fr 0.8fr 0.8fr 0.7fr 44px",padding:"14px 20px",borderBottom:`1px solid ${T.n100}`,gap:12,alignItems:"center",cursor:"pointer",transition:"background 150ms",opacity:inv.status==="cancelado"?0.5:1,animation:`fadeSlideUp 0.3s ease ${i*0.03}s both`}} onMouseEnter={e=>e.currentTarget.style.background=T.n100} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><span style={{fontSize:13,fontWeight:600,color:T.primary500,fontFamily:"monospace"}}>{inv.id}</span><div><div style={{fontSize:14,fontWeight:500}}>{inv.patient}</div><div style={{fontSize:12,color:T.n400,marginTop:1}}>{inv.professional}</div></div><span style={{fontSize:13,color:T.n700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{inv.description}</span><span style={{fontSize:15,fontWeight:700}}>R$ {inv.amount}</span><div><div style={{fontSize:13}}>{new Date(inv.dueDate).toLocaleDateString("pt-BR")}</div>{inv.status==="atrasado"&&<div style={{fontSize:11,color:T.error,marginTop:1}}>{Math.floor((new Date()-new Date(inv.dueDate))/86400000)}d atraso</div>}</div><Badge color={st.color} bg={st.bg}><StIcon size={11}/> {st.label}</Badge><button onClick={e=>e.stopPropagation()} style={{width:32,height:32,borderRadius:6,border:"none",background:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400}}><MoreHorizontal size={16}/></button></div>)})}</div></div>}

{/* DESPESAS */}
{tab==="despesas"&&<div style={{animation:"fadeSlideUp 0.3s ease both"}}><div style={{display:"flex",alignItems:"center",gap:10,marginBottom:16,flexWrap:"wrap"}}><div style={{flex:1,maxWidth:320,display:"flex",alignItems:"center",border:`1.5px solid ${T.n300}`,borderRadius:T.radiusMd,background:T.n0,overflow:"hidden"}}><span style={{paddingLeft:12,color:T.n400,display:"flex"}}><Search size={16}/></span><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar despesa ou fornecedor..." style={{flex:1,border:"none",outline:"none",padding:"10px 12px",fontSize:13,fontFamily:T.font,color:T.n900,background:"transparent"}}/>{search&&<button onClick={()=>setSearch("")} style={{border:"none",background:"none",cursor:"pointer",padding:"0 10px",color:T.n400,display:"flex"}}><X size={14}/></button>}</div><select value={statusFilter} onChange={e=>setStatusFilter(e.target.value)} style={{padding:"9px 12px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,fontFamily:T.font,fontSize:13,color:T.n700,cursor:"pointer",appearance:"auto"}}><option value="all">Todos os status</option><option value="pendente">Pendente</option><option value="pago">Pago</option><option value="atrasado">Atrasado</option></select><select value={catFilter} onChange={e=>setCatFilter(e.target.value)} style={{padding:"9px 12px",borderRadius:T.radiusMd,border:`1.5px solid ${T.n300}`,background:T.n0,fontFamily:T.font,fontSize:13,color:T.n700,cursor:"pointer",appearance:"auto"}}><option value="all">Todas as categorias</option>{EXPENSE_CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}</select><div style={{display:"flex",gap:6}}>{[{id:"all",label:"Todas"},{id:"recorrente",label:"Recorrentes"},{id:"eventual",label:"Eventuais"}].map(f=>(<button key={f.id} onClick={()=>setTypeFilter(f.id)} style={{padding:"7px 14px",borderRadius:20,cursor:"pointer",border:`1.5px solid ${typeFilter===f.id?T.primary500:T.n300}`,background:typeFilter===f.id?T.primary50:T.n0,color:typeFilter===f.id?T.primary500:T.n400,fontFamily:T.font,fontSize:12,fontWeight:500,transition:"all 200ms"}}>{f.id==="recorrente"&&<Repeat size={11} style={{marginRight:4,verticalAlign:-1}}/>}{f.label}</button>))}</div><span style={{fontSize:12,color:T.n400,marginLeft:"auto"}}>{filteredDesp.length} despesas</span></div><div style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,overflow:"hidden"}}><div style={{display:"grid",gridTemplateColumns:"90px 2fr 1fr 1fr 0.7fr 0.7fr 0.6fr 44px",padding:"12px 20px",background:T.n100,borderBottom:`1px solid ${T.n200}`,gap:10,alignItems:"center"}}>{["Nº","Descrição","Categoria","Fornecedor","Valor","Vencimento","Status",""].map((h,i)=><span key={i} style={{fontSize:12,fontWeight:600,color:T.n400,textTransform:"uppercase",letterSpacing:"0.04em"}}>{h}</span>)}</div>{filteredDesp.length===0?<div style={{padding:"48px 20px",textAlign:"center",color:T.n400}}><ShoppingCart size={32} style={{margin:"0 auto 12px",opacity:0.3}}/><div style={{fontSize:14}}>Nenhuma despesa encontrada</div></div>:filteredDesp.map((d,i)=>{const st=DESP_STATUS[d.status];const StIcon=st.icon;const cat=EXPENSE_CATEGORIES.find(c=>c.id===d.category)||EXPENSE_CATEGORIES[11];const CatIcon=cat.icon;return(<div key={d.id} onClick={()=>{setEditDesp(d);setDespModal(true)}} style={{display:"grid",gridTemplateColumns:"90px 2fr 1fr 1fr 0.7fr 0.7fr 0.6fr 44px",padding:"14px 20px",borderBottom:`1px solid ${T.n100}`,gap:10,alignItems:"center",cursor:"pointer",transition:"background 150ms",animation:`fadeSlideUp 0.3s ease ${i*0.03}s both`}} onMouseEnter={e=>e.currentTarget.style.background=T.n100} onMouseLeave={e=>e.currentTarget.style.background="transparent"}><span style={{fontSize:13,fontWeight:600,color:T.orange,fontFamily:"monospace"}}>{d.id}</span><div><div style={{fontSize:14,fontWeight:500,display:"flex",alignItems:"center",gap:5}}>{d.description}{d.recurrent&&<span style={{display:"inline-flex",alignItems:"center",gap:3,padding:"1px 6px",borderRadius:4,background:T.primary50,color:T.primary500,fontSize:10,fontWeight:600}}><Repeat size={9}/>REC</span>}</div></div><div style={{display:"flex",alignItems:"center",gap:5,fontSize:12,color:T.n700}}><CatIcon size={13} color={cat.color}/> {cat.label}</div><span style={{fontSize:13,color:T.n700}}>{d.supplier}</span><span style={{fontSize:15,fontWeight:700}}>R$ {d.amount.toLocaleString("pt-BR")}</span><span style={{fontSize:13}}>{new Date(d.dueDate).toLocaleDateString("pt-BR")}</span><Badge color={st.color} bg={st.bg}><StIcon size={11}/> {st.label}</Badge><button onClick={e=>e.stopPropagation()} style={{width:32,height:32,borderRadius:6,border:"none",background:"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:T.n400}}><MoreHorizontal size={16}/></button></div>)})}</div></div>}

{/* FORNECEDORES */}
{tab==="fornecedores"&&<div style={{animation:"fadeSlideUp 0.3s ease both"}}><div style={{display:"flex",alignItems:"center",gap:10,marginBottom:16}}><div style={{flex:1,maxWidth:340,display:"flex",alignItems:"center",border:`1.5px solid ${T.n300}`,borderRadius:T.radiusMd,background:T.n0,overflow:"hidden"}}><span style={{paddingLeft:12,color:T.n400,display:"flex"}}><Search size={16}/></span><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Buscar fornecedor..." style={{flex:1,border:"none",outline:"none",padding:"10px 12px",fontSize:13,fontFamily:T.font,color:T.n900,background:"transparent"}}/></div><span style={{fontSize:12,color:T.n400,marginLeft:"auto"}}>{suppliers.length} fornecedores</span></div><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(340px, 1fr))",gap:14}}>{suppliers.filter(s=>!search||s.name.toLowerCase().includes(search.toLowerCase())).map((s,i)=>{const cat=EXPENSE_CATEGORIES.find(c=>c.id===s.category)||EXPENSE_CATEGORIES[11];const CatIcon=cat.icon;return(<div key={s.id} onClick={()=>{setEditSup(s);setSupModal(true)}} style={{background:T.n0,borderRadius:T.radiusLg,border:`1px solid ${T.n200}`,boxShadow:T.shadowSoft,padding:20,cursor:"pointer",transition:"all 200ms",animation:`fadeSlideUp 0.3s ease ${i*0.04}s both`}} onMouseEnter={e=>{e.currentTarget.style.boxShadow="0 4px 12px rgba(0,0,0,0.07)";e.currentTarget.style.transform="translateY(-2px)"}} onMouseLeave={e=>{e.currentTarget.style.boxShadow=T.shadowSoft;e.currentTarget.style.transform="none"}}><div style={{display:"flex",alignItems:"center",gap:14,marginBottom:14}}><div style={{width:44,height:44,borderRadius:10,background:`${cat.color}14`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><CatIcon size={20} color={cat.color}/></div><div style={{flex:1,minWidth:0}}><div style={{fontSize:15,fontWeight:600}}>{s.name}</div><div style={{fontSize:12,color:T.n400,marginTop:1}}>{cat.label}</div></div><Edit3 size={14} color={T.n300}/></div><div style={{display:"flex",gap:8,fontSize:12,color:T.n400,marginBottom:10,flexWrap:"wrap"}}>{s.cnpj&&<span style={{display:"flex",alignItems:"center",gap:3}}><Hash size={11}/> {s.cnpj}</span>}{s.phone&&<span style={{display:"flex",alignItems:"center",gap:3}}><Phone size={11}/> {s.phone}</span>}</div><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",background:T.n100,borderRadius:T.radiusSm}}><span style={{fontSize:12,color:T.n400}}>Total pago</span><span style={{fontSize:15,fontWeight:700}}>R$ {s.totalPaid.toLocaleString("pt-BR")}</span></div>{s.notes&&<div style={{fontSize:12,color:T.n400,marginTop:10,fontStyle:"italic"}}>{s.notes}</div>}</div>)})}</div></div>}

<CobrancaModal open={cobModal} onClose={()=>setCobModal(false)} onCreate={createCharge} rawPatients={rawPatients}/>
<DespesaModal open={despModal} onClose={()=>{setDespModal(false);setEditDesp(null)}} expense={editDesp} onCreate={createExpense} onUpdate={updateExpense}/>
<SupplierModal open={supModal} onClose={()=>{setSupModal(false);setEditSup(null)}} supplier={editSup} onCreate={createSupplier} onUpdate={updateSupplier}/>
</div>)}

/* ═══ MAIN ═══ */
